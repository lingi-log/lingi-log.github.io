<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Autowired와 AOP | Lingi04</title>
    <meta name="description" content="개발 관련 이것 저것">
    
    
    <link rel="preload" href="/assets/css/0.styles.4b6fa609.css" as="style"><link rel="preload" href="/assets/js/app.9bf9b52a.js" as="script"><link rel="preload" href="/assets/js/2.2f398f54.js" as="script"><link rel="preload" href="/assets/js/35.10b1c933.js" as="script"><link rel="prefetch" href="/assets/js/10.d4a80777.js"><link rel="prefetch" href="/assets/js/11.42b53835.js"><link rel="prefetch" href="/assets/js/12.202d46c9.js"><link rel="prefetch" href="/assets/js/13.6b965925.js"><link rel="prefetch" href="/assets/js/14.88717f6a.js"><link rel="prefetch" href="/assets/js/15.0e36bd3d.js"><link rel="prefetch" href="/assets/js/16.444397c9.js"><link rel="prefetch" href="/assets/js/17.6d5f1186.js"><link rel="prefetch" href="/assets/js/18.c27d2f83.js"><link rel="prefetch" href="/assets/js/19.5069e2ba.js"><link rel="prefetch" href="/assets/js/20.887f805f.js"><link rel="prefetch" href="/assets/js/21.ac4d3914.js"><link rel="prefetch" href="/assets/js/22.9bb43966.js"><link rel="prefetch" href="/assets/js/23.14e2eac5.js"><link rel="prefetch" href="/assets/js/24.fcbf8df3.js"><link rel="prefetch" href="/assets/js/25.67802c13.js"><link rel="prefetch" href="/assets/js/26.35ac2a96.js"><link rel="prefetch" href="/assets/js/27.12f0db9a.js"><link rel="prefetch" href="/assets/js/28.e6301139.js"><link rel="prefetch" href="/assets/js/29.41f5368b.js"><link rel="prefetch" href="/assets/js/3.87a0ff5a.js"><link rel="prefetch" href="/assets/js/30.920286bf.js"><link rel="prefetch" href="/assets/js/31.a28662b9.js"><link rel="prefetch" href="/assets/js/32.d5bc20f7.js"><link rel="prefetch" href="/assets/js/33.9fa2dacf.js"><link rel="prefetch" href="/assets/js/34.ea35f454.js"><link rel="prefetch" href="/assets/js/36.4129a5da.js"><link rel="prefetch" href="/assets/js/37.eee328ed.js"><link rel="prefetch" href="/assets/js/38.aec9f681.js"><link rel="prefetch" href="/assets/js/39.4e8e7e14.js"><link rel="prefetch" href="/assets/js/4.d7ee998c.js"><link rel="prefetch" href="/assets/js/40.a4d5f179.js"><link rel="prefetch" href="/assets/js/41.fe7864f5.js"><link rel="prefetch" href="/assets/js/42.cfb9021c.js"><link rel="prefetch" href="/assets/js/43.837843f8.js"><link rel="prefetch" href="/assets/js/44.8f9bfb2e.js"><link rel="prefetch" href="/assets/js/45.e465b911.js"><link rel="prefetch" href="/assets/js/46.0d94a68f.js"><link rel="prefetch" href="/assets/js/47.c2c4c2f0.js"><link rel="prefetch" href="/assets/js/48.ed4315b9.js"><link rel="prefetch" href="/assets/js/49.957cf810.js"><link rel="prefetch" href="/assets/js/5.e74b6197.js"><link rel="prefetch" href="/assets/js/50.d7d8231c.js"><link rel="prefetch" href="/assets/js/51.be3f93d0.js"><link rel="prefetch" href="/assets/js/52.4c4db762.js"><link rel="prefetch" href="/assets/js/53.46c3ef6f.js"><link rel="prefetch" href="/assets/js/54.0cbb4096.js"><link rel="prefetch" href="/assets/js/55.6082caee.js"><link rel="prefetch" href="/assets/js/56.b4abce8b.js"><link rel="prefetch" href="/assets/js/57.e3054a16.js"><link rel="prefetch" href="/assets/js/58.2441b7d7.js"><link rel="prefetch" href="/assets/js/59.92d58df3.js"><link rel="prefetch" href="/assets/js/6.b4ec9f4c.js"><link rel="prefetch" href="/assets/js/60.60f2359b.js"><link rel="prefetch" href="/assets/js/61.a42c8532.js"><link rel="prefetch" href="/assets/js/62.34196576.js"><link rel="prefetch" href="/assets/js/63.220b8f7b.js"><link rel="prefetch" href="/assets/js/64.76f9f384.js"><link rel="prefetch" href="/assets/js/65.0f8c7dfd.js"><link rel="prefetch" href="/assets/js/66.2a7bf695.js"><link rel="prefetch" href="/assets/js/67.893bc67a.js"><link rel="prefetch" href="/assets/js/68.be686ee3.js"><link rel="prefetch" href="/assets/js/69.7f8a9188.js"><link rel="prefetch" href="/assets/js/7.1e9a546b.js"><link rel="prefetch" href="/assets/js/70.5be336f3.js"><link rel="prefetch" href="/assets/js/71.6e1ad52f.js"><link rel="prefetch" href="/assets/js/72.2c3ce851.js"><link rel="prefetch" href="/assets/js/73.24eca150.js"><link rel="prefetch" href="/assets/js/74.7ea296eb.js"><link rel="prefetch" href="/assets/js/75.60d30dc8.js"><link rel="prefetch" href="/assets/js/8.09056a9a.js"><link rel="prefetch" href="/assets/js/9.a3851888.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4b6fa609.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/thumbnail.png" alt="Lingi04" class="logo"> <span class="site-name can-hide">Lingi04</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study/" class="nav-link">Study</a></div><div class="nav-item"><a href="/backend/" class="nav-link">Backend</a></div><div class="nav-item"><a href="/experiences/" class="nav-link router-link-active">Experiences</a></div><div class="nav-item"><a href="/about.html" class="nav-link">About</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study/" class="nav-link">Study</a></div><div class="nav-item"><a href="/backend/" class="nav-link">Backend</a></div><div class="nav-item"><a href="/experiences/" class="nav-link router-link-active">Experiences</a></div><div class="nav-item"><a href="/about.html" class="nav-link">About</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Experiences</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/experiences/1-deadlock_exception.html" class="sidebar-link">Deadlock 현상 해결</a></li><li><a href="/experiences/2-Autowired와_AOP.html" class="active sidebar-link">Autowired와 AOP</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/experiences/2-Autowired와_AOP.html#문제상황" class="sidebar-link">문제상황</a></li><li class="sidebar-sub-header"><a href="/experiences/2-Autowired와_AOP.html#무엇이-예외를-발생시켰나" class="sidebar-link">무엇이 예외를 발생시켰나</a></li><li class="sidebar-sub-header"><a href="/experiences/2-Autowired와_AOP.html#aop-간단하게" class="sidebar-link">AOP... 간단하게!</a></li><li class="sidebar-sub-header"><a href="/experiences/2-Autowired와_AOP.html#갑자기-웬-aop일까" class="sidebar-link">갑자기 웬 AOP일까</a></li><li class="sidebar-sub-header"><a href="/experiences/2-Autowired와_AOP.html#원인" class="sidebar-link">원인</a></li><li class="sidebar-sub-header"><a href="/experiences/2-Autowired와_AOP.html#문제-해결은-어떻게" class="sidebar-link">문제 해결은 어떻게?</a></li></ul></li><li><a href="/experiences/3-shellscript_kill.html" class="sidebar-link">Shell script와 kill 명령어</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="autowired와-aop">Autowired와 AOP</h1> <p>AOP(Aspect-oriendted Programming)는 OOP를 보완하는 수단으로, 흩어진 Aspect를 모듈화 할 수 있는 프로그래밍 기법 이고, Autowired는 Spring에서 아~주 간편하게 의존성을 주입하는 방법이다. 토이프로젝트를 진행하며 AOP와 Autowired를 함께 사용하다 겪은 문제상황과 이를 해결한 경험을 기록해놓고자 한다.</p> <h2 id="문제상황">문제상황</h2> <p>Controller에 Bean으로 등록한 Service를 @Autowired를 통해 주입 받아 사용하려 했지만 <code>BeanNotOfRequiredTypeException</code>이 발생했다. 분명 어제까진 된것 같은데... 뭐때문에 발생한걸까?</p> <blockquote><h3 id="beannotofrequiredtypeexception은-언제-발생하지">BeanNotOfRequiredTypeException은 언제 발생하지?</h3> <p><a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/beans/factory/BeanNotOfRequiredTypeException.html" target="_blank" rel="noopener noreferrer">spring 문서<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>를 보면 이 Exception은 Bean이 예상 타입과 다를 때(Thrown when a bean doesn't match the expected type.) 발생한다고 한다.</p></blockquote> <p>수정했던코드를 한단계씩 되돌려가며 실행해 보았고, 예외를 발생시킨 수정을 찾을 수 있었다.</p> <h2 id="무엇이-예외를-발생시켰나">무엇이 예외를 발생시켰나</h2> <ul><li>코드 A - 정상동작<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeployController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">Deploy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeployItemReqDto</span><span class="token punctuation">&gt;</span></span> deployComp<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li>코드 B - 예외발생 케이스<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeployController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">DeployItem</span> deployComp<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <p>음 뭐가 다른거지??</p> <p>일단 클래스 다이어그램을 보자.
<img src="https://raw.githubusercontent.com/lingi-log/lingi-log/master/assets/images/experiences/deployclassdiagram.jpeg" alt=""></p> <p>인터페이스 <code>Deploy&lt;T&gt;</code>가 있고, 이를 구현한 추상클래스 <code>DeployItem</code>와 클래스 <code>DeployGroup</code>이 있다. 그리고 추상클래스 <code>DeployItem</code>를 상속받은 클래스 <code>DeployItemA</code>, <code>DeployItemB</code>, <code>DeployItemC</code>가 있다. <code>DeployGroup</code>, <code>DeployItemA</code>, <code>DeployItemB</code>, <code>DeployItemC</code>는 <code>@Service</code> 어노테이션을 붙여 Bean으로 등록했다. (설계를 왜 이렇게 했는지에 대한 의문이 든다면 잠시 접어두자.)</p> <p>다시 코드를 보면 인터페이스인 <code>Deploy&lt;T&gt;</code>를 필드로 선언했을 땐 정상 동작하지만  추상클래스 <code>DeployItem</code>를 필드로 선언했을 때 예외가 발생한다는 것을 알 수 있다. 여전히 아리송하다.</p> <p>이쯤 보고 로그를 다시 보자. 뭔가 건질만한게 있을까?</p> <div class="language- extra-class"><pre class="language-text"><code>Caused by: org.springframework.beans.factory.BeanNotOfRequiredTypeException: Bean named 'deployItemC' is expected to be of type 'com.goodluck.newwm.api.library.deploy.service.DeployItem' but was actually of type 'com.sun.proxy.$Proxy95'
</code></pre></div><p>여전히 모르겠지만 이상한 점이 하나 보인다. 왜 <code>deployComp</code>의 타입이 <code>com.sun.proxy.$Proxy95</code>이지?</p> <p>회사 동료와 스터디원들에게 물어봤지만 원인을 찾지 못했는데 끈질긴 구글링 덕에 원인을 찾을 수 있었는데, 그 전에 AOP에 대해 살짝 알아보자.</p> <h2 id="aop-간단하게">AOP... 간단하게!</h2> <p>앞서 말한것 처럼 AOP(Aspect-oriendted Programming)는 OOP를 보완하는 수단으로, 흩어진 Aspect를 모듈화 할 수 있는 프로그래밍 기법 이다.</p> <h3 id="aop-용어">AOP 용어</h3> <table><thead><tr><th>용어</th> <th>설명</th></tr></thead> <tbody><tr><td>Aspect</td> <td>공통적으로 적용될 기능을 의미. 횡단 관심사의 기능이라고도 할 수 잇으며 한 개 이상이 Pointcut과 Advice 조합으로 만들어진다.</td></tr> <tr><td>Advice</td> <td>관점의 구현체로 조인포인트에 삽입되어 동작하는것을 의미함. 스프링에서 사용하는 Advice는 동작하는 시점에따라 다섯 종류로 구분된다.</td></tr> <tr><td>Jointpoint</td> <td>어드바이스를 적용하는 지점을 의미. 스프링에서 Jointpoint는 항상 메서드 실행단계만 가능하다.</td></tr> <tr><td>Pointcut</td> <td>Advice를 적용할 조인트포인트를 선별하는 과정이나 그 기능을 정의한 모듈을 의미. 정규표현식이나 AspectJ문법을 이용하여 어떤 Jointpoint를 사용할지 결정.</td></tr> <tr><td>Target</td> <td>Advice를 받을 대상을 의미</td></tr> <tr><td>Weaving</td> <td>어드바이스를 적용하는것을 의미. 공통 코드를 원하는 대상에 삽입하는것을 의미한다.</td></tr></tbody></table> <h3 id="weaving">Weaving</h3> <table><thead><tr><th>종류</th> <th>설명</th></tr></thead> <tbody><tr><td>Runtime weaving</td> <td>JDK dynamic proxy 나 CGLIB proxy를 생성하여 실행시간에 target에 weaving 하는 방식</td></tr> <tr><td>Compile-time weaving</td> <td>컴파일 시점에 Application 소스코드와 Aspect 코드를 Weaving 하여 AOP가 적용된 클래스를 만들어내는 방식</td></tr> <tr><td>Post-compile weaving</td> <td>Binary weaving이라고도 하며 이미 존재하는 클래스나 JAR파일을 조작하여 weaving 한다.</td></tr> <tr><td>Load-time weaving</td> <td>Weaving 하는 시점을 class loader가 class를 jvm에 로드하는 시점으로 늦춘 것 빼고 Post-compile weaving방식과 동일.</td></tr></tbody></table> <h3 id="aop-구현체">AOP 구현체</h3> <ul><li>AspectJ</li> <li>스프링 AOP</li></ul> <h3 id="스프링-aop">스프링 AOP</h3> <p>Runtime weaving 방식을 사용하며 프록시 기반 AOP 구현체이다.</p> <h3 id="runtime-weaving">Runtime weaving</h3> <p>proxy(JDK dynamic proxy 나 CGLIB prox)를 사용하여 구현되었다.</p> <p><img src="https://raw.githubusercontent.com/lingi-log/lingi-log/master/assets/images/backend/springboot/aop-3.png" alt="runtime weaving"></p> <p>둘의 차이점은, JDK dynamic proxy는 interface 기반, CGLIB proxy는 class 기반이라는 것이다.
JDK dynamic proxy – Spring AOP에서 선호하는 방법이다. targeted object가 interface를 구현하였다면 JDK dynamic proxy가 사용된다.
CGLIB proxy – target object가 interface를 구현하지 않았다면, CGLIB proxy 가 사용된다.</p> <h2 id="갑자기-웬-aop일까">갑자기 웬 AOP일까</h2> <p>갑자기 웬 AOP?라고 생각할 수도 있지만 <code>DeployItem</code>을 구현할때</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Async</span><span class="token punctuation">(</span><span class="token string">&quot;asyncExecutor&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deploy</span><span class="token punctuation">(</span><span class="token class-name">DeployItemReqDto</span> deployItemReqDto<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>이렇게 <code>@Async</code> 어노테이션을 붙여놨는데, <code>@Async</code>는 AOP 기반으로 동작하게 된다. 뭔가 알것같다.</p> <h2 id="원인">원인</h2> <p>추상클래스 <code>DeployItem</code>에 <code>@Async</code> 어노테이션을 사용했기 때문에 <code>DeployItem</code>를 상속받은 클래스 <code>DeployItemA</code>, <code>DeployItemB</code>, <code>DeployItemC</code>는 <strong>proxy를 통해서 동작</strong>하게 된다. 이 소스에선 AOP 설정을 따로 한게 없기 때문에 SpringAOP(JDK dynamic proxy 기반)를 통해 구현 된다. 그래서 이때 주입받으려는 bean의 필드의 종류를 Interface가 아닌 추상클래스나 구체 클래스를 선언하면 에러가 나는것이었다.</p> <h2 id="문제-해결은-어떻게">문제 해결은 어떻게?</h2> <p>고생한것에 비해 문제 해결방법은 간단했다. AOP가 적용된 Bean을 주입받기 위해선</p> <ol><li>필드를 interface로 선언<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeployController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">Deploy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeployItemReqDto</span><span class="token punctuation">&gt;</span></span> deployComp<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li>proxy의 종류를 <code>CGLIB proxy</code>로 변경<div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableAsync</span><span class="token punctuation">(</span>proxyTargetClass<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;asyncExecutor&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><code>AspectJ</code>를 사용하면 된다.<div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableAsync</span><span class="token punctuation">(</span>mode<span class="token operator">=</span> <span class="token class-name">AdviceMode</span><span class="token punctuation">.</span>ASPECTJ<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;asyncExecutor&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/experiences/1-deadlock_exception.html" class="prev">Deadlock 현상 해결</a></span> <span class="next"><a href="/experiences/3-shellscript_kill.html">Shell script와 kill 명령어</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9bf9b52a.js" defer></script><script src="/assets/js/2.2f398f54.js" defer></script><script src="/assets/js/35.10b1c933.js" defer></script>
  </body>
</html>
