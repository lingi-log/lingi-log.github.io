<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Deadlock 현상 해결 | Lingi04</title>
    <meta name="description" content="개발 관련 이것 저것">
    
    
    <link rel="preload" href="/assets/css/0.styles.4b6fa609.css" as="style"><link rel="preload" href="/assets/js/app.125ed9be.js" as="script"><link rel="preload" href="/assets/js/2.2f398f54.js" as="script"><link rel="preload" href="/assets/js/33.85d7eaf2.js" as="script"><link rel="prefetch" href="/assets/js/10.d4a80777.js"><link rel="prefetch" href="/assets/js/11.42b53835.js"><link rel="prefetch" href="/assets/js/12.202d46c9.js"><link rel="prefetch" href="/assets/js/13.aa7cd9fc.js"><link rel="prefetch" href="/assets/js/14.b55cad91.js"><link rel="prefetch" href="/assets/js/15.0e36bd3d.js"><link rel="prefetch" href="/assets/js/16.444397c9.js"><link rel="prefetch" href="/assets/js/17.2d8be2fd.js"><link rel="prefetch" href="/assets/js/18.c27d2f83.js"><link rel="prefetch" href="/assets/js/19.5069e2ba.js"><link rel="prefetch" href="/assets/js/20.887f805f.js"><link rel="prefetch" href="/assets/js/21.ac4d3914.js"><link rel="prefetch" href="/assets/js/22.431aeb88.js"><link rel="prefetch" href="/assets/js/23.c376cd71.js"><link rel="prefetch" href="/assets/js/24.94424115.js"><link rel="prefetch" href="/assets/js/25.db5067e5.js"><link rel="prefetch" href="/assets/js/26.45a8eb7a.js"><link rel="prefetch" href="/assets/js/27.b033714f.js"><link rel="prefetch" href="/assets/js/28.f18b24de.js"><link rel="prefetch" href="/assets/js/29.41f5368b.js"><link rel="prefetch" href="/assets/js/3.4d03bf94.js"><link rel="prefetch" href="/assets/js/30.920286bf.js"><link rel="prefetch" href="/assets/js/31.a28662b9.js"><link rel="prefetch" href="/assets/js/32.d5bc20f7.js"><link rel="prefetch" href="/assets/js/34.ea35f454.js"><link rel="prefetch" href="/assets/js/35.10b1c933.js"><link rel="prefetch" href="/assets/js/36.72207db9.js"><link rel="prefetch" href="/assets/js/37.d363ac7f.js"><link rel="prefetch" href="/assets/js/38.df47cb06.js"><link rel="prefetch" href="/assets/js/39.80648ed7.js"><link rel="prefetch" href="/assets/js/4.d7ee998c.js"><link rel="prefetch" href="/assets/js/40.67c8bb77.js"><link rel="prefetch" href="/assets/js/41.39683a1e.js"><link rel="prefetch" href="/assets/js/42.99ea81b1.js"><link rel="prefetch" href="/assets/js/43.f5427513.js"><link rel="prefetch" href="/assets/js/44.f029afbd.js"><link rel="prefetch" href="/assets/js/45.323c69d8.js"><link rel="prefetch" href="/assets/js/46.6e81bafe.js"><link rel="prefetch" href="/assets/js/47.036f35ce.js"><link rel="prefetch" href="/assets/js/48.270db365.js"><link rel="prefetch" href="/assets/js/49.666ea254.js"><link rel="prefetch" href="/assets/js/5.e74b6197.js"><link rel="prefetch" href="/assets/js/50.7e1da9f0.js"><link rel="prefetch" href="/assets/js/51.ffbdc893.js"><link rel="prefetch" href="/assets/js/52.ad03b774.js"><link rel="prefetch" href="/assets/js/53.7732e069.js"><link rel="prefetch" href="/assets/js/54.eb070188.js"><link rel="prefetch" href="/assets/js/55.d955b9b3.js"><link rel="prefetch" href="/assets/js/56.ee1818ae.js"><link rel="prefetch" href="/assets/js/57.4ff3dfd5.js"><link rel="prefetch" href="/assets/js/58.484e2a00.js"><link rel="prefetch" href="/assets/js/59.007a4488.js"><link rel="prefetch" href="/assets/js/6.b4ec9f4c.js"><link rel="prefetch" href="/assets/js/60.1edb6967.js"><link rel="prefetch" href="/assets/js/61.dfe09a57.js"><link rel="prefetch" href="/assets/js/62.a8f28db8.js"><link rel="prefetch" href="/assets/js/63.daf2a8fd.js"><link rel="prefetch" href="/assets/js/64.04456cc7.js"><link rel="prefetch" href="/assets/js/65.c2005777.js"><link rel="prefetch" href="/assets/js/66.e6f8a136.js"><link rel="prefetch" href="/assets/js/67.9cdcbd0f.js"><link rel="prefetch" href="/assets/js/68.660af9b2.js"><link rel="prefetch" href="/assets/js/69.d5aa4926.js"><link rel="prefetch" href="/assets/js/7.1e9a546b.js"><link rel="prefetch" href="/assets/js/70.7bcb4b5a.js"><link rel="prefetch" href="/assets/js/71.348f92db.js"><link rel="prefetch" href="/assets/js/72.1bfe6b54.js"><link rel="prefetch" href="/assets/js/73.488b226f.js"><link rel="prefetch" href="/assets/js/74.43dc2de9.js"><link rel="prefetch" href="/assets/js/75.0f13d356.js"><link rel="prefetch" href="/assets/js/76.1076269a.js"><link rel="prefetch" href="/assets/js/77.3e1485cf.js"><link rel="prefetch" href="/assets/js/78.c54450b7.js"><link rel="prefetch" href="/assets/js/79.c4a8188c.js"><link rel="prefetch" href="/assets/js/8.09056a9a.js"><link rel="prefetch" href="/assets/js/80.e3d0d4f3.js"><link rel="prefetch" href="/assets/js/9.a3851888.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4b6fa609.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/thumbnail.png" alt="Lingi04" class="logo"> <span class="site-name can-hide">Lingi04</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study/" class="nav-link">Study</a></div><div class="nav-item"><a href="/backend/" class="nav-link">Backend</a></div><div class="nav-item"><a href="/programming/Immutable.html" class="nav-link">Programming</a></div><div class="nav-item"><a href="/experiences/" class="nav-link router-link-active">Experiences</a></div><div class="nav-item"><a href="/about.html" class="nav-link">About</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study/" class="nav-link">Study</a></div><div class="nav-item"><a href="/backend/" class="nav-link">Backend</a></div><div class="nav-item"><a href="/programming/Immutable.html" class="nav-link">Programming</a></div><div class="nav-item"><a href="/experiences/" class="nav-link router-link-active">Experiences</a></div><div class="nav-item"><a href="/about.html" class="nav-link">About</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Experiences</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/experiences/1-deadlock_exception.html" class="active sidebar-link">Deadlock 현상 해결</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/experiences/1-deadlock_exception.html#환경" class="sidebar-link">환경</a></li><li class="sidebar-sub-header"><a href="/experiences/1-deadlock_exception.html#현상" class="sidebar-link">현상</a></li><li class="sidebar-sub-header"><a href="/experiences/1-deadlock_exception.html#분석" class="sidebar-link">분석</a></li><li class="sidebar-sub-header"><a href="/experiences/1-deadlock_exception.html#shared-and-exclusive-locks" class="sidebar-link">Shared and Exclusive Locks</a></li><li class="sidebar-sub-header"><a href="/experiences/1-deadlock_exception.html#정리를-하자면" class="sidebar-link">정리를 하자면</a></li></ul></li><li><a href="/experiences/2-Autowired와_AOP.html" class="sidebar-link">Autowired와 AOP</a></li><li><a href="/experiences/3-kill과_trap.html" class="sidebar-link">Kill과 trap</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>깨끗한 코드</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>과제 풀이</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="deadlock-현상-해결">Deadlock 현상 해결</h1> <p>고객사로부터 특정 요청이 간헐적으로 실패가 난다는 이슈가 접수되었다. 로그를 확인해보니 Deadlock exception 발생하고 있었고 이슈를 해결하며 찾아보며 알게된 것들을 정리한다.</p> <h2 id="환경">환경</h2> <table><thead><tr><th></th> <th></th></tr></thead> <tbody><tr><td>DB</td> <td>MariaDB</td></tr> <tr><td>Engine</td> <td>InnoDB</td></tr> <tr><td>Isolation Level</td> <td>Repeatable Read</td></tr></tbody></table> <h2 id="현상">현상</h2> <p>톰캣 catalina 로그를 확인해보면 아래와 같은 exception 나고 있었다.</p> <p><img src="https://raw.githubusercontent.com/lingi-log/lingi-log/master/assets/images/db/deadlock_err_msg.PNG" alt="deadlockexception시지"></p> <h4 id="exception내용-deadlock-found-when-trying-to-get-lock-try-restarting-transaction">exception내용 : <em>Deadlock found when trying to get lock; try restarting transaction</em></h4> <p>일단 exception메시지를 보면 <em>lock을 가져오려 하는데 Deadlock이 발생하여 트랜잭션을 재시작</em>하겠다 정도로 해석할 수 있다.</p> <p>당장 떠오른 해결방법은 두가지 였고, 장단점은 명확했다.</p> <table><thead><tr><th>-</th> <th>해결법</th> <th>장점</th> <th>단점</th></tr></thead> <tbody><tr><td>1</td> <td>문제가 되는 요청을 호출 하지 않도록 변경하자<br>(이슈를 접수한 고객사는 다행히 해당 기능을 사용하지 않는 고객이었다.)</td> <td>바로 해결 가능</td> <td>향후에 해당 기능 사용할 때 혹은 다른 고객사에서도 동일한 이슈가 발생할 수 있다.</td></tr> <tr><td>2</td> <td>exception 나는 원인을 파악 후 해결하자</td> <td>근본적인 해결책</td> <td>원인을 파악하는데 어느 정도의 시간이 걸릴 것이고, 고객은 그때까지 계속 exception 나는 상태로 사용해야 한다.</td></tr></tbody></table> <p>물론 누가봐도 2번을 선택해서 문제를 해결 해야했지만 당장의 issue 해결도 중요했기에 일단 임시방편으로 고객사에 1번 조치를 하고 근본적인 원인을 분석 후 이슈가 해결된 버전을 전달하기로 했다.</p> <p>그럼 지금부터 <strong>어떤 상황에서 어떤 쿼리가 lock을 가져오려 했고, 왜 가져오지 못해 Deadlock이 발생</strong>했는지 알아보자.</p> <h2 id="분석">분석</h2> <p>Deadlock exception 난 곳을 확인해보니 A 프로시저 수행 중 이 프로시저에서 select 하는 테이블을(정확히 말하면 update 문 안에 select문이 있다) 다른 프로시저 B에서 그 테이블을 update 하는 쿼리 수행 중 exception 발생하고 있었다. 발생 패턴을 찾은 후 exception발생 재현을 성공했고, 본격적으로 분석에 들어갔다.</p> <p>처음 의문이 든 점은 update문이 수행될 때 어떤 lock을 거는지 였다. update가 대상 테이블에 어떤 lock을 걸길래, 또 그 테이블에 어떤 lock이 걸려있길래 deadlock이 걸리는걸까?</p> <h3 id="update문이-거는-lock">Update문이 거는 lock</h3> <p>처음엔 구글링을 통해 알아봤지만, 좀 더 정확한 정보를 위해 <a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locks-set.html" target="_blank" rel="noopener noreferrer">mysql 문서<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>내용을 가져왔다.</p> <blockquote><p><em>UPDATE 또는 DELETE는 일반적으로 SQL 문 처리에서 스캔되는 모든 인덱스 레코드에 레코드 잠금을 설정한다</em> ... ... , <em>WHERE절에 적절한 인덱스를 사용하지 않으면 MySQL은 쿼리를 수행하기 위해 전체 table에 lock을 건다</em></p></blockquote> <p>보통은 <code>update</code>되는 대상 row에 <code>record lock</code>이 걸리지만, where절에 인덱스를 적절히 태우지 않거나 인덱스가 없는 경우는 <strong>테이블 전체에 lock</strong>이 걸린다!</p> <p>확인 결과 B프로시저 update문은 index를 타고 있지 않았고 쿼리 수행할 때 table 전체에 lock을 걸고 있었다. 그리고 테이블에 index를 생성하여 update대상의 row만 record lock이 걸리도록 변경했다. 해결했다는 기쁨을 가지고 테스트 했지만 예상은 보기좋게 빗나갔다. 발생 빈도는 줄었지만 동일한 exception 발생했다.</p> <h3 id="무엇이-문제였을까">무엇이 문제였을까</h3> <p>Deadlock에 관해 대충만 알고있어서 이런 생각을 하게 된것 같다. Where절에 index를 태움으로서 lock의 범위가 table에서 record로 줄어들긴 했지만 Deadlock이 생길만한 요소를 제거했다고 보기 어려웠다. 다시 분석에 들어갔다.</p> <h3 id="deadlock-관련-로그-분석">Deadlock 관련 로그 분석</h3> <p>검색을 통해 알게되었는데, <code>show engine innodb status</code>를 통해 가장 최근에 발생한 deadlock에 대한 정보를 알 수 있었다.</p> <p>로그는</p> <div class="language- extra-class"><pre class="language-text"><code>------------------------
LATEST DETECTED DEADLOCK
------------------------
2020-01-10 18:16:32 7fee7a600700
*** (1) TRANSACTION:
TRANSACTION 92465172, ACTIVE 0 sec fetching rows
mysql tables in use 1, locked 1
LOCK WAIT 3 lock struct(s), heap size 360, 6 row lock(s), undo log entries 1
MySQL thread id 949396, OS thread handle 0x7fef8cfb6700, query id 28309277 127.0.0.1 root updating
UPDATE    {tbl_a}   SET    {date_col} = now()   WHERE    {client_key} = '{value}'
*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 981 page no 3 n bits 128 index `PRIMARY` of table `kmng`.`t_asset_equi` trx id 92465172 lock_mode X waiting
*** (2) TRANSACTION:
TRANSACTION 92465171, ACTIVE 0 sec starting index read
mysql tables in use 36, locked 36
5 lock struct(s), heap size 1184, 3 row lock(s)
MySQL thread id 949674, OS thread handle 0x7fee7a600700, query id 28309288 localhost root Sending data
update {tbl_b} b, 
        (
            SELECT 
                {columns...}
                (SELECT {id} FROM {tbl_a} a WHERE {client_key} = '{value}') as ID,
                {columns...}
*** (2) HOLDS THE LOCK(S):
RECORD LOCKS space id 981 page no 3 n bits 128 index `PRIMARY` of table {tbl_a} trx id 92465171 lock mode S locks rec but not gap
*** (2) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 981 page no 3 n bits 128 index `PRIMARY` of table {tbl_a} trx id 92465171 lock mode S waiting
*** WE ROLL BACK TRANSACTION (1)
</code></pre></div><p>이렇게 생겼는데, 데드락이 발생한 원인에 대한 정보를 가지고 있다.
분석을 해보면</p> <ol><li>92465172번 트랜잭션이 {tbl_a} 테이블을 update를 하기 위해 space id 981 page no 3 부분에  lock_mode X를 거려고 기다리고 있고</li> <li>92465171번 트랜잭션이(tranjaction 번호가 더 빠른것으로 보아 먼저 실행된 것을 알 수 있다.) space id 981 page no 3 부분에 mode S locks을 걸고 있고, space id 981 page no 3 부분에 또 lock mode S를 걸기 위해 기다리고 있다.(shared lock은 기본적으로 lock을 공유하지만 shared lock이 걸린 row에 쓰기를 허용하지 않는다.)</li> <li>92465171번 트랜잭션이 먼저 shared lock을 걸고있고, 92465172번 트랜잭션이 update를 위해 exclusive lock을 걸기 위해 기다리고 있는 상태에서 92465171번 트랜잭션이 다시 shared lock을 거려고 하는 상태에서</li> <li>로그 마지막 부분을 보면 교착상태를 해소하기 위해 92465172번 트랜잭션을 rollback 한다고 나와있다.</li> <li>추가적으로, 92465171번 트랜잭션이 mode S locks을 건 row에 왜 한번 더 mode S locks을 걸려고 하는지 분석이 필요해 보인다.</li></ol> <blockquote><h2 id="shared-and-exclusive-locks">Shared and Exclusive Locks</h2> <p>The two standard row-level locks are share locks(S) and exclusive locks(X).</p> <p>A shared lock is obtained to read a row, and allows other transactions to read the locked row, but not to write to the locked row. Other transactions may also acquire their own shared locks.</p> <p>An exclusive lock is obtained to write to a row, and stops other transactions from locking the same row. It's specific behavior depends on the isolation level; the default (REPEATABLE READ), allow other transactions to read from the exclusively locked row.(https://mariadb.com/kb/en/innodb-lock-modes/)</p></blockquote> <p>해결에 대한 희망이 조금씩 보이기 시작했다. 일단 92465171 트랜잭션 안의 select문을 제거하고 외부에서 변수를 전달해주는 방식으로 변경하고 다시 테스트를 진행했다.</p> <h3 id="해결">해결</h3> <p>해결이 될것이라 강하게 믿었지만 여전히 exception은 발생하고 있었다. 조금 멘붕에 빠져서 팀원들에게 조언을 구하던 중 문제가 됐던 트랜잭션 이후에 수행되는 트리거가 있다는 것을 알게 되었고, 역시나 그 트리거에서도 문제의 테이블을 접근하고 있었다.</p> <p>결국 관련된 모든 프로시저에서 문제의 테이블 select 하는 부분을 제거하였고 다시 테스트를 돌려본 결과 이젠 진짜 문제가 해결되었다는 것을 확인하였다.</p> <h2 id="정리를-하자면">정리를 하자면</h2> <ul><li>update문 실행 시 보통 where절에 걸리는 row만 lock이 걸리지만 쿼리가 index를 타지 못하는 경우 테이블 전체에 lock이 걸린다.</li> <li>shared lock은 기본적으로 lock을 공유하지만 shared lock이 걸린 row에 쓰기를 허용하지 않는다.</li> <li>프로시저에 update문이 있고 그 안에 select문은 사용하지 않는 것이 좋다.</li> <li>DB Engine의 Isolation Level에 따라 동작방식이 달라지는데 읽어보다 그냥 패스했다... 기회가 되면 정리해봐야겠다!!</li> <li><code>show engine innodb status</code> 쿼리를 통해 deadlock 발생 정보를 확인할 수 있다. (가장 최근 1건에 대해서만)</li> <li>트랜잭션과 트리거(function도 추가)에 대한 의문이... 디버깅을 할 수도 없고 의존성(어디서 어떤 테이블 참조하고, 어떤 트리거가 발생하는지)을 찾기도 힘들다. 물어보니 속도가 빨라서 사용한다고 하시던데 과연 이게 최선의 선택일까.</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/experiences/2-Autowired와_AOP.html">Autowired와 AOP</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.125ed9be.js" defer></script><script src="/assets/js/2.2f398f54.js" defer></script><script src="/assets/js/33.85d7eaf2.js" defer></script>
  </body>
</html>
