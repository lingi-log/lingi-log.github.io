<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>매핑 | Lingi-log</title>
    <meta name="description" content="Blog About Study">
    
    
    <link rel="preload" href="/assets/css/0.styles.d01e3fed.css" as="style"><link rel="preload" href="/assets/js/app.1caafb5a.js" as="script"><link rel="preload" href="/assets/js/2.d65de26e.js" as="script"><link rel="preload" href="/assets/js/11.2a642ac0.js" as="script"><link rel="prefetch" href="/assets/js/10.c70bc64c.js"><link rel="prefetch" href="/assets/js/12.df0f84c4.js"><link rel="prefetch" href="/assets/js/13.c6b0351d.js"><link rel="prefetch" href="/assets/js/14.0167cab8.js"><link rel="prefetch" href="/assets/js/15.fb7b258c.js"><link rel="prefetch" href="/assets/js/16.e2be0002.js"><link rel="prefetch" href="/assets/js/17.027c3921.js"><link rel="prefetch" href="/assets/js/18.c843bdb1.js"><link rel="prefetch" href="/assets/js/19.b66c5afc.js"><link rel="prefetch" href="/assets/js/20.457ab411.js"><link rel="prefetch" href="/assets/js/21.2a5b09d8.js"><link rel="prefetch" href="/assets/js/22.9c3281a1.js"><link rel="prefetch" href="/assets/js/23.d0c432da.js"><link rel="prefetch" href="/assets/js/24.d862aaa2.js"><link rel="prefetch" href="/assets/js/25.a2e10fc2.js"><link rel="prefetch" href="/assets/js/26.b9b97f71.js"><link rel="prefetch" href="/assets/js/27.e0265c5e.js"><link rel="prefetch" href="/assets/js/28.d7011eb2.js"><link rel="prefetch" href="/assets/js/29.1285ba91.js"><link rel="prefetch" href="/assets/js/3.59d35063.js"><link rel="prefetch" href="/assets/js/30.9be1c58c.js"><link rel="prefetch" href="/assets/js/31.c4990921.js"><link rel="prefetch" href="/assets/js/32.c2ee6748.js"><link rel="prefetch" href="/assets/js/33.92c9245f.js"><link rel="prefetch" href="/assets/js/34.df08c575.js"><link rel="prefetch" href="/assets/js/35.08eb9892.js"><link rel="prefetch" href="/assets/js/36.8f58b877.js"><link rel="prefetch" href="/assets/js/37.1b3ac677.js"><link rel="prefetch" href="/assets/js/38.109a8e53.js"><link rel="prefetch" href="/assets/js/39.d7a0c3a6.js"><link rel="prefetch" href="/assets/js/4.bba3f465.js"><link rel="prefetch" href="/assets/js/40.fdbcd24f.js"><link rel="prefetch" href="/assets/js/41.9f8c7f01.js"><link rel="prefetch" href="/assets/js/42.02c5580b.js"><link rel="prefetch" href="/assets/js/43.3d2ac087.js"><link rel="prefetch" href="/assets/js/44.3e769886.js"><link rel="prefetch" href="/assets/js/5.df890fb5.js"><link rel="prefetch" href="/assets/js/6.e788b34a.js"><link rel="prefetch" href="/assets/js/7.9580c619.js"><link rel="prefetch" href="/assets/js/8.1b702546.js"><link rel="prefetch" href="/assets/js/9.5891f351.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d01e3fed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/thumbnail.png" alt="Lingi-log" class="logo"> <span class="site-name can-hide">Lingi-log</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study/" class="nav-link">Study</a></div><div class="nav-item"><a href="/backend/" class="nav-link router-link-active">Backend</a></div><div class="nav-item"><a href="/frontend/" class="nav-link">Frontend</a></div><div class="nav-item"><a href="/linux/" class="nav-link">Linux</a></div><div class="nav-item"><a href="/db/" class="nav-link">DB</a></div><div class="nav-item"><a href="/about.html" class="nav-link">About</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study/" class="nav-link">Study</a></div><div class="nav-item"><a href="/backend/" class="nav-link router-link-active">Backend</a></div><div class="nav-item"><a href="/frontend/" class="nav-link">Frontend</a></div><div class="nav-item"><a href="/linux/" class="nav-link">Linux</a></div><div class="nav-item"><a href="/db/" class="nav-link">DB</a></div><div class="nav-item"><a href="/about.html" class="nav-link">About</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Spring Boot</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Spring Security</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/backend/springboot-security.html" class="sidebar-link">Spring Security</a></li><li><a href="/backend/springboot-security_2_config.html" class="sidebar-link">Spring security - config</a></li><li><a href="/backend/springboot-security_3_인증방식.html" class="sidebar-link">Spring security - 인증방식</a></li><li><a href="/backend/springboot-security_4_filter.html" class="sidebar-link">Spring security - filter</a></li><li><a href="/backend/springboot-security_5_provider.html" class="sidebar-link">Spring Security - provider</a></li><li><a href="/backend/springboot-security_6_entrypoint.html" class="sidebar-link">Spring Security - entry point</a></li><li><a href="/backend/springboot-security_7_exceptions.html" class="sidebar-link">Spring Security - exceptions</a></li></ul></section></li><li><a href="/backend/springboot-annotation.html" class="sidebar-link">Spring Boot Annotation 정리</a></li><li><a href="/backend/springboot-jpa.html" class="sidebar-link">JPA(Java Persistence API)</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Elastic Search</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/backend/es_1_세팅.html" class="sidebar-link">Elasticsearch 세팅 정리</a></li><li><a href="/backend/es_2_매핑.html" class="active sidebar-link">매핑</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/es_2_매핑.html#매핑-예시" class="sidebar-link">매핑 예시</a></li><li class="sidebar-sub-header"><a href="/backend/es_2_매핑.html#data-type" class="sidebar-link">Data type</a></li></ul></li><li><a href="/backend/es_4_DB와 비교.html" class="sidebar-link">RDB와 ElasticSearch의 관계</a></li><li><a href="/backend/es_5_성능최적화.html" class="sidebar-link">성능 최적화</a></li><li><a href="/backend/es_6_alias.html" class="sidebar-link">alias 설정</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="매핑">매핑</h1> <blockquote><p>데이터를 집어넣으면 자동으로 매핑을 생성해준다.<br>
하지만  최적화를 위해 매핑을 직접 정의할 수 있다.</p></blockquote> <h2 id="매핑-예시">매핑 예시</h2> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">curl</span> -XPOST -H <span class="token string">'Content-Type: application/json'</span> <span class="token string">'http://10.10.0.41:9200/my_index/_mapping/my_type?include_type_name=true'</span> -d @./my_mapping.json
</code></pre></div><h2 id="data-type">Data type</h2> <blockquote><p>데이터를 집어넣고 성능 테스트를 하던 중 nested datatype에 대한 어려움을 겪어, 공부하고 정리도 할 겸 공식 문서를 번역해 보았다.(https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html)</p></blockquote> <h3 id="nested-타입">Nested 타입</h3> <p>Nested 타입은 object array 형태의 데이터를 인덱싱하기 위한 타입이다. Object array를 nested 타입으로 저장하면 array의 각 요소를 독립적으로 query 할 수 있다.</p> <h4 id="array-는-어떻게-flattened-되나">array 는 어떻게 flattened 되나?</h4> <p>Object안의 array는 우리가 생각하는 것 처럼 동작하지 않는다. Lucene은 inner object의 개념이 없기 떄문에 Elasticsearch는 아래 예시와 같이 hierarchy가 있는 데이터를 name과 value의 간단한 리스트 형태로 변환한다.</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT my_index/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;group&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;fans&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;user&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span> 	<span class="token comment">// The user field is dynamically added as a field of type object.</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;first&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;last&quot;</span> <span class="token operator">:</span>  <span class="token string">&quot;Smith&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;first&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;last&quot;</span> <span class="token operator">:</span>  <span class="token string">&quot;White&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>would be transformed internally into a document that looks more like this:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;group&quot;</span> <span class="token operator">:</span>        <span class="token string">&quot;fans&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;user.first&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;alice&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;john&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;user.last&quot;</span> <span class="token operator">:</span>  <span class="token punctuation">[</span> <span class="token string">&quot;smith&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;white&quot;</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>user.first</code>와 <code>user.last</code> 필드는 multi-value field로 flattened 되고, <strong><code>alice</code>와 <code>white</code>간의 관계는 없어진다.</strong> 따라서 예상과 다른 query 결과를 얻게된다.</p> <h4 id="array-object를-nested필드로-저장하기">array object를 nested필드로 저장하기</h4> <p>만약 object 배열을 인덱스 하고 배열의 각 인자 간 독립성을 유지하고 싶다면, nested datatype을 사용하면 된다.
Nested datatype은 내부적으로 object datatype과 다르게, 배열의 각 object를 분리된 hidden document로 index 한다. 때문에 각 nested object는 nested query를 이용하여 독립적으로 쿼리될 수 있다.</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT my_index
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;user&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nested&quot;</span> <span class="token comment">// The user field is mapped as type nested instead of type object.</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

PUT my_index/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;group&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;fans&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;user&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;first&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;last&quot;</span> <span class="token operator">:</span>  <span class="token string">&quot;Smith&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;first&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;last&quot;</span> <span class="token operator">:</span>  <span class="token string">&quot;White&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

GET my_index/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span> <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;user.first&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Alice&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;user.last&quot;</span><span class="token operator">:</span>  <span class="token string">&quot;Smith&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment">// This query doesn’t match because Alice and Smith are not in the same nested object.</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

GET my_index/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span> <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;user.first&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Alice&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;user.last&quot;</span><span class="token operator">:</span>  <span class="token string">&quot;White&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment">// This query matches because Alice and White are in the same nested object.</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;inner_hits&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// inner_hits allow us to highlight the matching nested documents.</span>
        <span class="token property">&quot;highlight&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;user.first&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Nested document는:</p> <ul><li>Nested query로 query될 수 있다.</li> <li>Nested and reverse_nested aggregations로 분석할 수 있다.</li> <li>Nested sorting으로 sort 된다.</li> <li>Nested inner hits로 retrieved and highlighted 됨.</li></ul> <blockquote><p>Nested document는 별도의 document로 색인되기 때문에, newted query, nested/reverse_nested agregations, nested inner hits로만 접근이 가능하다.<br>
For instance, if a string field within a nested document has index_options set to offsets to allow use of the postings during the highlighting, these offsets will not be available during the main highlighting phase. Instead, highlighting needs to be performed via nested inner hits. The same consideration applies when loading fields during a search through docvalue_fields or stored_fields.</p></blockquote> <h4 id="nested-fields의-parameter">Nested fields의 parameter</h4> <p>Nested field에는 아래의 인자를 사용할 수 있다:</p> <table><thead><tr><th>-</th> <th>-</th></tr></thead> <tbody><tr><td>dynamic</td> <td>Whether or not new properties should be added dynamically to an existing nested object. Accepts true (default), false and strict.</td></tr> <tr><td>properties</td> <td>The fields within the nested object, which can be of any datatype, including nested. New properties may be added to an existing nested object.</td></tr></tbody></table> <h4 id="nested-mappings-and-objects-의-개수-제한">Nested mappings and objects 의 개수 제한</h4> <p>앞서 언급한 것 처럼, 각각의 nested object는 별도의 문서로 hood 아래 저장된다.(indexed as a separate document under the hood). 위 예시를 이어서 설명하면, 만약 1개의 document가 100 개의 user object를 가지고 있으면, 101개(parent document 1개, nested document 100개)의 Lucene document가 생성된다. Nested object 매핑과 관련된 비용으로 인한 성능 문제를 방지하기 위해 Elasticsearch는 nested field 개수에 대한 제한을 둔다:</p> <ul><li>index.mapping.nested_fields.limit
<ul><li>The nested type should only be used in special cases, when arrays of objects need to be queried independently of each other. To safeguard against poorly designed mappings, this setting limits the number of unique nested types per index. 위 예제에서 nested field 개수는 1 이다. 기본 설정값은 50이다.</li></ul></li> <li>index.mapping.nested_objects.limit
<ul><li>This setting limits the number of nested objects that a single document may contain across all nested types, in order to prevent out of memory errors when a document contains too many nested objects. To illustrate how the setting works, say we added another nested type called comments to our example mapping above. Then for each document, the combined number of user and comment objects it contains must be below the limit. Defaults to 10000.</li></ul></li></ul> <p>Additional background on these settings, including information on their default values, can be found in Settings to prevent mappings explosion.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">8/26/2019, 7:47:43 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/backend/es_1_세팅.html" class="prev">
          Elasticsearch 세팅 정리
        </a></span> <span class="next"><a href="/backend/es_4_DB와 비교.html">
          RDB와 ElasticSearch의 관계
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1caafb5a.js" defer></script><script src="/assets/js/2.d65de26e.js" defer></script><script src="/assets/js/11.2a642ac0.js" defer></script>
  </body>
</html>
